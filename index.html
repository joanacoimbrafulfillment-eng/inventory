<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inventory Management System v50</title>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <style>
        :root{--primary:#2c3e50;--secondary:#34495e;--accent:#3498db;--success:#2ecc71;--warning:#f39c12;--danger:#e74c3c;--light:#ecf0f1;--dark:#2c3e50;--gray:#95a5a6;--border:#dcdcdc}
        *{margin:0;padding:0;box-sizing:border-box;font-family:Arial,sans-serif}
        body{background-color:var(--light);color:var(--dark)}
        header{background-color:var(--primary);color:#fff;padding:15px 20px;box-shadow:0 2px 5px rgba(0,0,0,.1)}
        h1{font-size:22px;margin-bottom:5px}
        .container{display:flex;height:calc(100vh - 70px)}
        .sidebar{width:250px;background-color:#fff;border-right:1px solid var(--border);overflow-y:auto;padding:20px}
        .main{flex:1;overflow-y:auto;padding:20px}
        .nav-item{padding:12px 15px;margin-bottom:5px;border-radius:5px;cursor:pointer;transition:all .2s;display:flex;align-items:center;font-weight:500}
        .nav-item:hover{background-color:var(--light)}
        .nav-item.active{background-color:var(--accent);color:#fff}
        .nav-icon{margin-right:10px;font-size:18px;width:20px;text-align:center}
        .card{background-color:#fff;border-radius:8px;box-shadow:0 2px 10px rgba(0,0,0,.05);padding:20px;margin-bottom:20px}
        .card-title{font-size:18px;font-weight:bold;margin-bottom:15px;padding-bottom:10px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center}
        .btn{padding:8px 15px;border:none;border-radius:4px;cursor:pointer;font-weight:500;transition:all .2s;display:inline-flex;align-items:center;justify-content:center}
        .btn-primary{background-color:var(--accent);color:#fff}
        .btn-secondary{background-color:var(--secondary);color:#fff}
        .btn-success{background-color:var(--success);color:#fff}
        .btn-warning{background-color:var(--warning);color:#fff}
        .btn-danger{background-color:var(--danger);color:#fff}
        .btn-light{background-color:var(--light);color:var(--dark);border:1px solid var(--border)}
        .btn:hover{opacity:.9;transform:translateY(-1px)}
        .btn-icon{margin-right:5px}
        table{width:100%;border-collapse:collapse;margin-top:15px}
        th,td{padding:10px;text-align:left;border-bottom:1px solid var(--border)}
        th{background-color:var(--light);font-weight:600}
        tr:hover{background-color:rgba(236,240,241,.5)}
        .input-group{margin-bottom:15px}
        label{display:block;margin-bottom:5px;font-weight:500}
        input,select,textarea{width:100%;padding:8px 10px;border:1px solid var(--border);border-radius:4px;font-size:14px}
        textarea{resize:vertical;min-height:80px}
        .row{display:flex;gap:15px;margin-bottom:15px}
        .col{flex:1}
        .badge{padding:3px 8px;border-radius:20px;font-size:12px;font-weight:600;display:inline-block}
        .badge-success{background-color:rgba(46,204,113,.2);color:var(--success)}
        .badge-warning{background-color:rgba(243,156,18,.2);color:var(--warning)}
        .badge-danger{background-color:rgba(231,76,60,.2);color:var(--danger)}
        .month-selector{display:flex;align-items:center;margin-bottom:20px}
        .month-selector select{width:auto;margin-right:10px}
        .dashboard{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:15px;margin-bottom:20px}
        .stat-card{background-color:#fff;border-radius:8px;padding:15px;box-shadow:0 2px 10px rgba(0,0,0,.05)}
        .stat-title{font-size:14px;color:var(--gray);margin-bottom:10px}
        .stat-value{font-size:24px;font-weight:bold}
        .stat-subtitle{font-size:12px;color:var(--gray);margin-top:5px}
        .hidden{display:none}
        .search-bar{display:flex;gap:10px;margin-bottom:15px}
        .search-bar input{flex:1}
        .filter-bar{display:flex;gap:10px;margin-bottom:15px;flex-wrap:wrap}
        .filter-item{display:flex;align-items:center;gap:5px}
        .filter-item select,.filter-item input{width:auto}
        .auth-bar{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-top:8px}
        .auth-bar input{width:220px}
        .auth-status{margin-left:auto;font-size:12px;opacity:.9}
        .legend{display:flex;gap:10px;flex-wrap:wrap;margin:8px 0 0 0;font-size:12px;color:#333}
        .legend .item{display:flex;align-items:center;gap:6px}
        .legend .swatch{width:16px;height:6px;border-radius:3px;display:inline-block}
        .qty-cell{display:flex;flex-direction:column;gap:6px}
        .qty-number{font-size:22px;font-weight:800;line-height:1;color:#000}
        .qty-bar{height:5px;border-radius:4px;background:#ccc}
        .small-note{font-size:12px;color:var(--gray)}
        .pill{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;background:rgba(52,152,219,.08);color:var(--primary);font-size:12px;border:1px solid rgba(52,152,219,.25)}
        .pill strong{font-weight:700}
    </style>
</head>
<body>
<header>
    <h1>Inventory Management System</h1>
    <div style="display:flex;gap:12px;align-items:center;flex-wrap:wrap">
        <div class="auth-bar">
            <input id="loginEmail" type="email" placeholder="email (.pt full / .pl general)" autocomplete="username" />
            <input id="loginPass" type="password" placeholder="password" autocomplete="current-password" />
            <button class="btn btn-light" id="btnLogin"><span class="btn-icon">üîê</span>Login</button>
            <button class="btn btn-light hidden" id="btnLogout"><span class="btn-icon">üö™</span>Logout</button>
            <span class="auth-status" id="authStatus">Not signed in</span>
        </div>
        <span class="pill" id="plRealtimeInfo" style="display:none"><strong>PL</strong> realtime general</span>
    </div>
</header>

<div class="container">
    <div class="sidebar">
        <div class="month-selector">
            <select id="monthSelect"></select>
            <button class="btn btn-light" id="newMonthBtn"><span class="btn-icon">+</span>New</button>
        </div>

        <div class="nav-item active" data-tab="general">
            <span class="nav-icon">üìä</span> General
        </div>
        <div class="nav-item" data-tab="warehouse">
            <span class="nav-icon">üè∑Ô∏è</span> Warehouse
        </div>
        <div class="nav-item" data-tab="management">
            <span class="nav-icon">‚öôÔ∏è</span> Management
        </div>
        <div class="nav-item" data-tab="adjustments">
            <span class="nav-icon">üìù</span> Adjustments
        </div>
        <div class="nav-item" data-tab="returns">
            <span class="nav-icon">üîÑ</span> Returns
        </div>
        <div class="nav-item" data-tab="internal">
            <span class="nav-icon">üßπ</span> Internal & Care
        </div>
        <div class="nav-item" data-tab="orders">
            <span class="nav-icon">üì¶</span> Orders & Shipments
        </div>
        <div class="nav-item" data-tab="amsped">
            <span class="nav-icon">‚úÖ</span> After Confirmation
        </div>
        <div class="nav-item" data-tab="b2b">
            <span class="nav-icon">ü§ù</span> B2B
        </div>
        <div class="nav-item" data-tab="movements">
            <span class="nav-icon">üßæ</span> Movements
        </div>
    </div>

    <div class="main">
        <!-- GENERAL TAB -->
        <div id="general" class="tab-content">
            <div class="card">
                <div class="card-title">
                    <span>Dashboard</span>
                    <span class="small-note" id="generalLastUpdate">Last update: ‚Äî</span>
                </div>

                <div class="dashboard" style="grid-template-columns:repeat(2,minmax(240px,1fr))">
                    <div class="stat-card">
                        <div class="stat-title">Total Received</div>
                        <div class="stat-value" id="totalReceived">0</div>
                        <div class="stat-subtitle">Items received this month</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-title">Total Transit (Sent)</div>
                        <div class="stat-value" id="totalTransit">0</div>
                        <div class="stat-subtitle">Items in transit</div>
                    </div>
                </div>

                <div class="legend">
                    <div class="item"><span class="swatch" style="background:#ff0000"></span><span>&lt; 0</span></div>
                    <div class="item"><span class="swatch" style="background:#ffb3b3"></span><span>0‚Äì10</span></div>
                    <div class="item"><span class="swatch" style="background:#fff3b0"></span><span>11‚Äì199</span></div>
                    <div class="item"><span class="swatch" style="background:#c6f6d5"></span><span>200‚Äì500</span></div>
                    <div class="item"><span class="swatch" style="background:#cfe8ff"></span><span>501+</span></div>
                </div>

                <div class="search-bar" style="margin-top:12px">
                    <input type="text" id="generalSearch" placeholder="Search products...">
                    <button class="btn btn-primary" id="refreshGeneralBtn"><span class="btn-icon">üîÑ</span>Refresh</button>
                    <button class="btn btn-secondary hidden" id="btnBackfillGeneral"><span class="btn-icon">üì£</span>Publicar meses p/ PL</button>
                </div>

                <table>
                    <thead>
                    <tr>
                        <th>Product</th>
                        <th>Real Stock</th>
                        <th>Stock after Confirmation</th>
                        <th>Sent (Transit)</th>
                    </tr>
                    </thead>
                    <tbody id="generalTableBody"></tbody>
                </table>
            </div>
        </div>

        <!-- WAREHOUSE TAB -->
        <div id="warehouse" class="tab-content hidden">
            <div class="card">
                <div class="card-title">
                    <span>Warehouse Master</span>
                    <div>
                        <input type="file" id="warehouseFile" accept=".csv,.xlsx" style="display:none">
                        <button class="btn btn-primary" id="warehouseUploadBtn"><span class="btn-icon">‚¨ÜÔ∏è</span>Upload</button>
                        <button class="btn btn-secondary" id="warehouseExportBtn"><span class="btn-icon">‚¨áÔ∏è</span>Export CSV</button>
                    </div>
                </div>
                <div class="small-note">Upload columns: A Product, B Position, C Dimensions, D Weight. Volume is auto from Dimensions.</div>
                <table>
                    <thead>
                    <tr>
                        <th>Product</th>
                        <th>Position</th>
                        <th>Dimensions</th>
                        <th>Weight</th>
                        <th>Volume (auto)</th>
                    </tr>
                    </thead>
                    <tbody id="warehouseTableBody"></tbody>
                </table>
            </div>
        </div>

        <!-- MANAGEMENT TAB -->
        <div id="management" class="tab-content hidden">
            <div class="card">
                <div class="card-title">
                    <span>Initial Quantities</span>
                    <div>
                        <input type="file" id="managementInitFile" accept=".csv,.xlsx" style="display:none">
                        <button class="btn btn-primary" id="btnImportInit"><span class="btn-icon">‚¨ÜÔ∏è</span>Import Init (A Product, B Qty)</button>
                        <button class="btn btn-secondary" id="btnExportInit"><span class="btn-icon">‚¨áÔ∏è</span>Export CSV</button>
                    </div>
                </div>
                <div class="row">
                    <div class="col">
                        <label>Product</label>
                        <input list="productList" id="initProduct">
                    </div>
                    <div class="col">
                        <label>Initial Qty</label>
                        <input type="number" id="initQty" value="0">
                    </div>
                    <div class="col" style="display:flex;align-items:flex-end">
                        <button class="btn btn-success" id="addInitBtn"><span class="btn-icon">+</span>Add/Update</button>
                    </div>
                </div>

                <table>
                    <thead>
                    <tr>
                        <th>Product</th>
                        <th>Initial Qty</th>
                    </tr>
                    </thead>
                    <tbody id="initTableBody"></tbody>
                </table>
            </div>
        </div>

        <!-- ADJUSTMENTS TAB -->
        <div id="adjustments" class="tab-content hidden">
            <div class="card">
                <div class="card-title">
                    <span>Adjustments</span>
                </div>

                <div class="row">
                    <div class="col">
                        <label>Adjustment Type</label>
                        <select id="adjustmentType">
                            <option value="received">Received</option>
                            <option value="lost">Lost</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div class="col">
                        <label>Product</label>
                        <input list="productList" id="adjustProduct">
                    </div>
                    <div class="col">
                        <label>Quantity</label>
                        <input type="number" id="adjustQty" value="1">
                    </div>
                    <div class="col" style="display:flex;align-items:flex-end">
                        <button class="btn btn-success" id="addAdjustBtn"><span class="btn-icon">+</span>Add</button>
                    </div>
                </div>

                <div class="row">
                    <div class="col">
                        <label>Bulk (one per line: PRODUCT ... QTY)</label>
                        <textarea id="adjustBulk"></textarea>
                    </div>
                    <div class="col" style="display:flex;align-items:flex-end">
                        <button class="btn btn-primary" id="addAdjustBulkBtn"><span class="btn-icon">‚ö°</span>Process Bulk</button>
                    </div>
                </div>

                <table>
                    <thead>
                    <tr>
                        <th>Date</th>
                        <th>Type</th>
                        <th>Product</th>
                        <th>Qty</th>
                        <th>By</th>
                        <th>Actions</th>
                    </tr>
                    </thead>
                    <tbody id="adjustTableBody"></tbody>
                </table>
            </div>
        </div>

        <!-- RETURNS TAB -->
        <div id="returns" class="tab-content hidden">
            <div class="card">
                <div class="card-title">
                    <span>Returns</span>
                </div>

                <div class="row">
                    <div class="col">
                        <label>Return Type</label>
                        <select id="returnType">
                            <option value="refund">Refund</option>
                            <option value="returns">Return to Stock</option>
                            <option value="recovered">Recovered</option>
                        </select>
                    </div>
                    <div class="col">
                        <label>Product</label>
                        <input list="productList" id="returnProduct">
                    </div>
                    <div class="col">
                        <label>Quantity</label>
                        <input type="number" id="returnQty" value="1">
                    </div>
                    <div class="col" style="display:flex;align-items:flex-end">
                        <button class="btn btn-success" id="addReturnBtn"><span class="btn-icon">+</span>Add</button>
                    </div>
                </div>

                <div class="row">
                    <div class="col">
                        <label>Bulk (one per line: PRODUCT ... QTY)</label>
                        <textarea id="returnsBulk"></textarea>
                    </div>
                    <div class="col" style="display:flex;align-items:flex-end;gap:10px">
                        <button class="btn btn-primary" id="addReturnsBulkBtn"><span class="btn-icon">‚ö°</span>Process Bulk</button>
                    </div>
                </div>

                <table>
                    <thead>
                    <tr>
                        <th>Date</th>
                        <th>Type</th>
                        <th>Product</th>
                        <th>Qty</th>
                        <th>By</th>
                        <th>Actions</th>
                    </tr>
                    </thead>
                    <tbody id="returnsTableBody"></tbody>
                </table>
            </div>
        </div>

        <!-- INTERNAL TAB -->
        <div id="internal" class="tab-content hidden">
            <div class="card">
                <div class="card-title"><span>Internal & Care</span></div>

                <div class="row">
                    <div class="col">
                        <label>Date</label>
                        <input type="date" id="internalDate">
                    </div>
                    <div class="col">
                        <label>Type</label>
                        <select id="internalType">
                            <option value="washing">Washing</option>
                            <option value="cleaning">Cleaning</option>
                            <option value="repair">Repair</option>
                        </select>
                    </div>
                </div>

                <div class="row">
                    <div class="col">
                        <label>Product</label>
                        <input list="productList" id="internalProduct">
                    </div>
                    <div class="col">
                        <label>Quantity</label>
                        <input type="number" id="internalQty" value="1">
                    </div>
                    <div class="col" style="display:flex;align-items:flex-end">
                        <button class="btn btn-success" id="addInternalBtn"><span class="btn-icon">+</span>Add</button>
                    </div>
                </div>

                <div class="row">
                    <div class="col">
                        <label>Bulk (one per line: PRODUCT ... QTY)</label>
                        <textarea id="internalBulk"></textarea>
                    </div>
                    <div class="col" style="display:flex;align-items:flex-end">
                        <button class="btn btn-primary" id="addInternalBulkBtn"><span class="btn-icon">‚ö°</span>Process Bulk</button>
                    </div>
                </div>

                <table>
                    <thead>
                    <tr>
                        <th>Date</th>
                        <th>Type</th>
                        <th>Product</th>
                        <th>Qty</th>
                        <th>By</th>
                        <th>Actions</th>
                    </tr>
                    </thead>
                    <tbody id="internalTableBody"></tbody>
                </table>
            </div>
        </div>

        <!-- ORDERS TAB -->
        <div id="orders" class="tab-content hidden">
            <div class="card">
                <div class="card-title"><span>Orders & Shipments</span></div>

                <div class="row">
                    <div class="col">
                        <label>Order Date</label>
                        <input type="date" id="orderDate">
                    </div>
                    <div class="col">
                        <label>Product</label>
                        <input list="productList" id="orderProduct">
                    </div>
                    <div class="col">
                        <label>Quantity</label>
                        <input type="number" id="orderQty" value="1">
                    </div>
                    <div class="col" style="display:flex;align-items:flex-end">
                        <button class="btn btn-success" id="addOrderBtn"><span class="btn-icon">+</span>Register Order</button>
                    </div>
                </div>

                <div class="row">
                    <div class="col">
                        <label>Bulk ORDER (one per line: PRODUCT ... QTY)</label>
                        <textarea id="orderBulk"></textarea>
                    </div>
                    <div class="col" style="display:flex;align-items:flex-end">
                        <button class="btn btn-primary" id="addOrderBulkBtn"><span class="btn-icon">‚ö°</span>Process ORDER Bulk</button>
                    </div>
                </div>

                <hr style="border:none;border-top:1px solid var(--border);margin:15px 0">

                <div class="row">
                    <div class="col">
                        <label>Shipment Date</label>
                        <input type="date" id="shipDate">
                    </div>
                    <div class="col">
                        <label>Product</label>
                        <input list="productList" id="shipProduct">
                    </div>
                    <div class="col">
                        <label>Quantity</label>
                        <input type="number" id="shipQty" value="1">
                    </div>
                    <div class="col">
                        <label>Obs (optional)</label>
                        <input type="text" id="shipNote" placeholder="e.g., pallet 3 / carrier / etc.">
                    </div>
                    <div class="col" style="display:flex;align-items:flex-end">
                        <button class="btn btn-warning" id="addShipBtn"><span class="btn-icon">üöö</span>Register SENT</button>
                    </div>
                </div>

                <div class="row">
                    <div class="col">
                        <label>Bulk SENT (one per line: PRODUCT ... QTY)</label>
                        <textarea id="shipBulk"></textarea>
                    </div>
                    <div class="col">
                        <label>Obs for Bulk (optional)</label>
                        <input type="text" id="shipBulkNote" placeholder="applied to all bulk lines">
                    </div>
                    <div class="col" style="display:flex;align-items:flex-end">
                        <button class="btn btn-primary" id="addShipBulkBtn"><span class="btn-icon">‚ö°</span>Process SENT Bulk</button>
                    </div>
                </div>

                <div class="card" style="margin-top:15px">
                    <div class="card-title">
                        <span>Open Shipments (SENT) ‚Äî Receive Inline</span>
                        <span class="small-note">Enter received qty/date per line. Partial receive keeps remaining SENT.</span>
                    </div>
                    <table>
                        <thead>
                        <tr>
                            <th>From Month</th>
                            <th>Sent Date</th>
                            <th>Product</th>
                            <th>Sent Qty</th>
                            <th>Remaining</th>
                            <th>Obs</th>
                            <th>Qty Received</th>
                            <th>Arrival Date</th>
                            <th>Receive</th>
                        </tr>
                        </thead>
                        <tbody id="openShipmentsBody"></tbody>
                    </table>
                </div>

                <div class="card" style="margin-top:15px">
                    <div class="card-title"><span>History</span></div>
                    <table>
                        <thead>
                        <tr>
                            <th>Date</th>
                            <th>Type</th>
                            <th>Product</th>
                            <th>Qty</th>
                            <th>Obs</th>
                            <th>By</th>
                        </tr>
                        </thead>
                        <tbody id="ordersTableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- AMSPED TAB -->
        <div id="amsped" class="tab-content hidden">
            <div class="card">
                <div class="card-title"><span>After Confirmation</span></div>

                <div class="row">
                    <div class="col">
                        <label>Product</label>
                        <input list="productList" id="amspedProduct">
                    </div>
                    <div class="col">
                        <label>Quantity</label>
                        <input type="number" id="amspedQty" value="1">
                    </div>
                    <div class="col" style="display:flex;align-items:flex-end">
                        <button class="btn btn-success" id="addAmspedBtn"><span class="btn-icon">+</span>Add</button>
                    </div>
                </div>

                <div class="row">
                    <div class="col">
                        <label>Bulk (one per line: PRODUCT ... QTY)</label>
                        <textarea id="amspedBulk"></textarea>
                    </div>
                    <div class="col" style="display:flex;align-items:flex-end">
                        <button class="btn btn-primary" id="addAmspedBulkBtn"><span class="btn-icon">‚ö°</span>Process Bulk</button>
                    </div>
                </div>

                <table>
                    <thead>
                    <tr>
                        <th>Date</th>
                        <th>Product</th>
                        <th>Qty</th>
                        <th>By</th>
                        <th>Actions</th>
                    </tr>
                    </thead>
                    <tbody id="amspedTableBody"></tbody>
                </table>
            </div>
        </div>

        <!-- B2B TAB -->
        <div id="b2b" class="tab-content hidden">
            <div class="card">
                <div class="card-title"><span>B2B</span></div>

                <div class="row">
                    <div class="col">
                        <label>Product</label>
                        <input list="productList" id="b2bProduct">
                    </div>
                    <div class="col">
                        <label>Quantity</label>
                        <input type="number" id="b2bQty" value="1">
                    </div>
                    <div class="col" style="display:flex;align-items:flex-end">
                        <button class="btn btn-success" id="addB2bBtn"><span class="btn-icon">+</span>Add</button>
                    </div>
                </div>

                <div class="row">
                    <div class="col">
                        <label>Bulk (one per line: PRODUCT ... QTY)</label>
                        <textarea id="b2bBulk"></textarea>
                    </div>
                    <div class="col" style="display:flex;align-items:flex-end">
                        <button class="btn btn-primary" id="addB2bBulkBtn"><span class="btn-icon">‚ö°</span>Process Bulk</button>
                    </div>
                </div>

                <table>
                    <thead>
                    <tr>
                        <th>Date</th>
                        <th>Product</th>
                        <th>Qty</th>
                        <th>By</th>
                        <th>Actions</th>
                    </tr>
                    </thead>
                    <tbody id="b2bTableBody"></tbody>
                </table>
            </div>
        </div>

        <!-- MOVEMENTS TAB -->
        <div id="movements" class="tab-content hidden">
            <div class="card">
                <div class="card-title">
                    <span>All Movements</span>
                    <div>
                        <button class="btn btn-secondary" id="exportMovementsCsvBtn"><span class="btn-icon">‚¨áÔ∏è</span>Export CSV</button>
                        <button class="btn btn-secondary" id="exportMovementsXlsxBtn"><span class="btn-icon">‚¨áÔ∏è</span>Export XLSX</button>
                    </div>
                </div>

                <div class="filter-bar">
                    <div class="filter-item">
                        <label style="margin:0">From</label>
                        <input type="date" id="movFrom">
                    </div>
                    <div class="filter-item">
                        <label style="margin:0">To</label>
                        <input type="date" id="movTo">
                    </div>
                    <div class="filter-item">
                        <label style="margin:0">Tab</label>
                        <select id="movTab">
                            <option value="">All</option>
                        </select>
                    </div>
                    <div class="filter-item">
                        <label style="margin:0">Product</label>
                        <input type="text" id="movProductSearch" placeholder="search...">
                    </div>
                    <button class="btn btn-primary" id="movApplyBtn"><span class="btn-icon">üîé</span>Apply</button>
                </div>

                <table>
                    <thead>
                    <tr>
                        <th>Month</th>
                        <th>Date</th>
                        <th>Tab</th>
                        <th>Type</th>
                        <th>Product</th>
                        <th>Qty</th>
                        <th>Obs</th>
                        <th>By</th>
                    </tr>
                    </thead>
                    <tbody id="movementsTableBody"></tbody>
                </table>
            </div>
        </div>

        <datalist id="productList"></datalist>
    </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-app.js";
  import {
    getAuth, onAuthStateChanged,
    signInWithEmailAndPassword, signOut,
    setPersistence, browserLocalPersistence
  } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-auth.js";
  import {
    initializeFirestore,
    doc, setDoc, getDoc, onSnapshot, serverTimestamp
  } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBvJIwx6KDSrwdnJ1o8vqvttsv9dzycY6g",
    authDomain: "inventario-57757.firebaseapp.com",
    projectId: "inventario-57757",
    storageBucket: "inventario-57757.firebasestorage.app",
    messagingSenderId: "882561809403",
    appId: "1:882561809403:web:c0d3e4c5dafa410d5d295e"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);

  const db = initializeFirestore(app, {
    experimentalForceLongPolling: true,
    useFetchStreams: false
  });

  await setPersistence(auth, browserLocalPersistence);

  window.__fb = { auth, db, doc, setDoc, getDoc, onSnapshot, serverTimestamp, signInWithEmailAndPassword, signOut };
</script>

<script>
/* =========================
   Data + Helpers
========================= */
const WARRANTY_LAST = new Set(["WARRANTY PT","WARRANTY ES"]);

function todayISO(){
  const d=new Date();
  return d.toISOString().slice(0,10);
}
function monthIdFromDate(dateStr){
  return dateStr.slice(0,7);
}
function ensureMonthList(select){
  const now=new Date();
  const y=now.getFullYear();
  const m=String(now.getMonth()+1).padStart(2,'0');
  const cur=`${y}-${m}`;
  if(!select.options.length){
    for(let i=0;i<24;i++){
      const d=new Date(y, now.getMonth()-i, 1);
      const id=`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
      const opt=document.createElement('option');
      opt.value=id; opt.textContent=id;
      select.appendChild(opt);
    }
  }
  select.value=cur;
  return cur;
}

function parseBulkLines(text){
  const lines = (text||"").split(/\r?\n/).map(l=>l.trim()).filter(Boolean);
  const out=[];
  for(const line of lines){
    const m=line.match(/^(.*)\s+(-?\d+(?:\.\d+)?)$/);
    if(!m) continue;
    const product=m[1].trim();
    const qty=Number(m[2]);
    if(!product || !Number.isFinite(qty)) continue;
    out.push({product, qty});
  }
  return out;
}

function dimToVolume(dimStr){
  if(!dimStr) return 0;
  const nums = (dimStr.match(/[\d]+(?:[.,]\d+)?/g)||[]).map(x=>Number(String(x).replace(',','.'))).filter(n=>Number.isFinite(n));
  if(nums.length<3) return 0;
  return +(nums[0]*nums[1]*nums[2]).toFixed(4);
}

function qtyColor(q){
  if(q < 0) return "#ff0000";
  if(q >= 0 && q <= 10) return "#ffb3b3";
  if(q >= 11 && q <= 199) return "#fff3b0";
  if(q >= 200 && q <= 500) return "#c6f6d5";
  return "#cfe8ff";
}

function sortWarrantyLast(arr, keyFn){
  const normal = [];
  const tail = [];
  for(const x of arr){
    const k = (keyFn?keyFn(x):x);
    if(WARRANTY_LAST.has(String(k).trim().toUpperCase())) tail.push(x);
    else normal.push(x);
  }
  return normal.concat(tail);
}

function isPTEmail(email){ return !!email && email.toLowerCase().endsWith(".pt"); }
function isPLEmail(email){ return !!email && email.toLowerCase().endsWith(".pl"); }

const state = {
  currentMonth: "",
  warehouse: [], // {product, position, dimensions, weight, volume}
  monthData: null, // {products: {product: {init}}, logs: []}
  role: "none",
  userEmail: ""
};

function blankMonth(){
  return { products: {}, logs: [] };
}

/* =========================
   Firebase storage wrappers
========================= */
async function fbGet(path){
  const { db, doc, getDoc } = window.__fb;
  const snap = await getDoc(doc(db, ...path));
  return snap.exists() ? snap.data() : null;
}
async function fbSet(path, data, merge=true){
  const { db, doc, setDoc } = window.__fb;
  await setDoc(doc(db, ...path), data, { merge });
}

function getActor(){
  const u = window.__fb?.auth?.currentUser;
  return { by: u?.email || "", uid: u?.uid || "" };
}

/* =========================
   Load / Save
========================= */
async function loadWarehouse(){
  const data = await fbGet(["meta","warehouse"]);
  state.warehouse = Array.isArray(data?.items) ? data.items : [];
}

async function saveWarehouse(){
  await fbSet(["meta","warehouse"], { items: state.warehouse, updatedAt: window.__fb.serverTimestamp(), updatedBy: state.userEmail }, true);
}

async function loadMonth(monthId){
  const data = await fbGet(["months", monthId]);
  state.monthData = data ? { products: data.products||{}, logs: data.logs||[] } : blankMonth();
}

async function saveMonth(){
  if(!state.currentMonth) return;
  await fbSet(["months", state.currentMonth], {
    products: state.monthData.products,
    logs: state.monthData.logs,
    updatedAt: window.__fb.serverTimestamp(),
    updatedBy: state.userEmail
  }, true);

  // Publish general view for PL
  if(state.role==="pt"){
    await publishGeneralForMonth(state.currentMonth);
  }
}

async function publishGeneralForMonth(monthId){
  const generalItems = computeGeneralItemsForMonth(monthId);
  await fbSet(["general", monthId], {
    monthId,
    items: generalItems,
    updatedAt: window.__fb.serverTimestamp(),
    updatedBy: state.userEmail
  }, true);
  document.getElementById("generalLastUpdate").textContent = "Last update: published";
}

async function backfillAllMonthsForPL(){
  // list from month select options (24 months) AND also include any months stored? We can't list without queries,
  // so we publish the months present in selector (good enough for your timeline).
  const opts = Array.from(document.getElementById("monthSelect").options).map(o=>o.value);
  for(const mid of opts){
    await loadMonth(mid);
    await publishGeneralForMonth(mid);
  }
  await loadMonth(state.currentMonth);
  renderAll();
}

/* =========================
   Calculations
========================= */
function getAllProducts(){
  const list = state.warehouse.map(x=>x.product).filter(Boolean);
  // Always include warranty if present
  return sortWarrantyLast(Array.from(new Set(list)), x=>x);
}

function ensureProductEntry(prod){
  if(!state.monthData.products[prod]) state.monthData.products[prod] = { init: 0 };
  return state.monthData.products[prod];
}

function addLog(entry){
  state.monthData.logs.push(entry);
}

function computeGeneralItemsForMonth(monthId){
  // Uses state.monthData currently loaded for that month.
  const products = getAllProducts();
  const logs = state.monthData.logs || [];

  // stock formula:
  // realStock = init + received + returnsToStock + recovered - lost - b2b - sentOut? (we treat SENT as transit only, not reducing realStock here?) 
  // In your earlier logic, SENT affects "Transit" and may subtract from "real"? We'll keep consistent with existing approach:
  // We'll compute:
  // receivedQty = adjustments.received + orders.received (+ maybe returnsToStock?) for dashboard
  // sentQty = shipments.sent remaining open (for transit)
  // afterConfirmation = realStock - amsped? (in your system amsped subtracts from both real and after-confirm; we keep as separate)
  // For safety, we follow log semantics:
  const initMap = {};
  for(const p of products){
    initMap[p] = Number(state.monthData.products[p]?.init || 0);
  }

  const deltaReal = Object.fromEntries(products.map(p=>[p,0]));
  const deltaAfter = Object.fromEntries(products.map(p=>[p,0]));
  const sentOpen = Object.fromEntries(products.map(p=>[p,0]));

  let totalReceived=0;

  // Apply logs
  for(const l of logs){
    const p = l.product;
    if(!products.includes(p)) continue;
    const q = Number(l.qty||0);
    if(!Number.isFinite(q)) continue;

    switch(l.tab){
      case "adjustments":
        if(l.type==="received"){ deltaReal[p]+=q; deltaAfter[p]+=q; totalReceived+=q; }
        else if(l.type==="lost"){ deltaReal[p]-=q; deltaAfter[p]-=q; }
        else { deltaReal[p]+=q; deltaAfter[p]+=q; }
        break;
      case "returns":
        if(l.type==="returns" || l.type==="recovered"){ deltaReal[p]+=q; deltaAfter[p]+=q; }
        // refund does not return to stock
        break;
      case "orders":
        if(l.type==="received"){ deltaReal[p]+=q; deltaAfter[p]+=q; totalReceived+=q; }
        if(l.type==="sent"){
          // transit open: remaining qty stored on log if present
          const rem = Number(l.remaining ?? q);
          sentOpen[p]+=rem;
        }
        break;
      case "amsped":
        // after confirmation subtracts from after and real? You asked B2B subtracts from both real and after-confirm, amsped already did similarly.
        deltaReal[p]-=q; deltaAfter[p]-=q;
        break;
      case "b2b":
        deltaReal[p]-=q; deltaAfter[p]-=q;
        break;
      case "internal":
        // no stock impact
        break;
      default:
        break;
    }
  }

  // Sort products by realStock asc, warranty last
  const items = products.map(p=>{
    const real = initMap[p] + (deltaReal[p]||0);
    const after = initMap[p] + (deltaAfter[p]||0);
    const sent = sentOpen[p]||0;
    return { product:p, realStock:real, afterConfirmation:after, sent:sent };
  });

  items.sort((a,b)=>a.realStock-b.realStock);
  const withWarrantyLast = sortWarrantyLast(items, x=>x.product.toUpperCase());
  return withWarrantyLast;
}

/* =========================
   Rendering
========================= */
function fillProductList(){
  const dl=document.getElementById("productList");
  dl.innerHTML="";
  for(const p of getAllProducts()){
    const opt=document.createElement("option");
    opt.value=p;
    dl.appendChild(opt);
  }
}

function renderWarehouse(){
  const tbody=document.getElementById("warehouseTableBody");
  tbody.innerHTML="";
  for(let i=0;i<state.warehouse.length;i++){
    const w=state.warehouse[i];
    const tr=document.createElement("tr");

    const tdP=document.createElement("td");
    tdP.textContent=w.product||"";
    tr.appendChild(tdP);

    const tdPos=document.createElement("td");
    const ipPos=document.createElement("input");
    ipPos.value=w.position||"";
    ipPos.oninput=()=>{ w.position=ipPos.value; saveWarehouse().catch(console.error); };
    tdPos.appendChild(ipPos);
    tr.appendChild(tdPos);

    const tdDim=document.createElement("td");
    const ipDim=document.createElement("input");
    ipDim.value=w.dimensions||"";
    ipDim.oninput=()=>{
      w.dimensions=ipDim.value;
      w.volume=dimToVolume(w.dimensions);
      tdVol.textContent=w.volume;
      saveWarehouse().catch(console.error);
    };
    tdDim.appendChild(ipDim);
    tr.appendChild(tdDim);

    const tdW=document.createElement("td");
    const ipW=document.createElement("input");
    ipW.type="text";
    ipW.value=w.weight||"";
    ipW.oninput=()=>{ w.weight=ipW.value; saveWarehouse().catch(console.error); };
    tdW.appendChild(ipW);
    tr.appendChild(tdW);

    var tdVol=document.createElement("td");
    tdVol.textContent=(w.volume ?? dimToVolume(w.dimensions)) || 0;
    tr.appendChild(tdVol);

    tbody.appendChild(tr);
  }
}

function renderInit(){
  const tbody=document.getElementById("initTableBody");
  tbody.innerHTML="";
  const items = Object.entries(state.monthData.products).map(([p,v])=>({product:p, init:Number(v.init||0)}));
  items.sort((a,b)=>a.product.localeCompare(b.product));
  const sorted = sortWarrantyLast(items, x=>x.product.toUpperCase());
  for(const it of sorted){
    const tr=document.createElement("tr");
    tr.innerHTML=`<td>${it.product}</td><td>${it.init}</td>`;
    tbody.appendChild(tr);
  }
}

function renderGeneral(){
  const tbody=document.getElementById("generalTableBody");
  tbody.innerHTML="";

  const search=(document.getElementById("generalSearch").value||"").toLowerCase();
  const items = (state.role==="pl" ? (state.plGeneralItems||[]) : computeGeneralItemsForMonth(state.currentMonth));

  // dashboard totals
  let totalReceived=0;
  let totalTransit=0;
  // totalReceived: count received logs in month data
  if(state.role!=="pl"){
    for(const l of (state.monthData.logs||[])){
      if(l.tab==="orders" && l.type==="received") totalReceived+=Number(l.qty||0);
      if(l.tab==="adjustments" && l.type==="received") totalReceived+=Number(l.qty||0);
    }
    const tmp = computeGeneralItemsForMonth(state.currentMonth);
    totalTransit = tmp.reduce((s,x)=>s+Number(x.sent||0),0);
  }else{
    totalTransit = items.reduce((s,x)=>s+Number(x.sent||0),0);
    // Received total is not in snapshot; leave 0 for PL dashboard (or compute from items? not possible). Keep 0.
  }

  document.getElementById("totalReceived").textContent = String(Math.round(totalReceived));
  document.getElementById("totalTransit").textContent = String(Math.round(totalTransit));

  // search + warranty last + already sorted by realStock in snapshot
  const filtered = items.filter(it=>it.product.toLowerCase().includes(search));
  for(const it of filtered){
    const tr=document.createElement("tr");

    const tdP=document.createElement("td");
    tdP.textContent=it.product;
    tr.appendChild(tdP);

    function qtyCell(q, withBar=true){
      const wrap=document.createElement("div");
      wrap.className="qty-cell";
      const num=document.createElement("div");
      num.className="qty-number";
      num.textContent = String(q);
      wrap.appendChild(num);
      if(withBar){
        const bar=document.createElement("div");
        bar.className="qty-bar";
        bar.style.background = qtyColor(Number(q));
        wrap.appendChild(bar);
      }
      return wrap;
    }

    const tdReal=document.createElement("td");
    tdReal.appendChild(qtyCell(it.realStock, true));
    tr.appendChild(tdReal);

    const tdAfter=document.createElement("td");
    tdAfter.appendChild(qtyCell(it.afterConfirmation, true));
    tr.appendChild(tdAfter);

    const tdSent=document.createElement("td");
    tdSent.textContent = String(it.sent||0); // no colors on sent
    tr.appendChild(tdSent);

    tbody.appendChild(tr);
  }
}

function renderLogs(tbodyId, tabName){
  const tbody=document.getElementById(tbodyId);
  tbody.innerHTML="";
  const logs = (state.monthData.logs||[]).filter(l=>l.tab===tabName);
  logs.sort((a,b)=>(a.date||"").localeCompare(b.date||""));
  for(let idx=0; idx<logs.length; idx++){
    const l=logs[idx];
    const tr=document.createElement("tr");
    const by=l.by||"";
    const note = l.note||"";
    if(tabName==="amsped" || tabName==="b2b"){
      tr.innerHTML=`<td>${l.date||""}</td><td>${l.product}</td><td>${l.qty}</td><td>${by}</td>
        <td><button class="btn btn-light" data-del="${idx}">Del</button></td>`;
    }else if(tabName==="orders"){
      tr.innerHTML=`<td>${l.date||""}</td><td>${l.type||""}</td><td>${l.product}</td><td>${l.qty}</td><td>${note}</td><td>${by}</td>`;
    }else{
      tr.innerHTML=`<td>${l.date||""}</td><td>${l.type||""}</td><td>${l.product}</td><td>${l.qty}</td><td>${by}</td>
        <td><button class="btn btn-light" data-del="${idx}">Del</button></td>`;
    }
    tbody.appendChild(tr);
  }

  // delete handlers
  tbody.querySelectorAll("button[data-del]").forEach(btn=>{
    btn.onclick=async ()=>{
      const i = Number(btn.getAttribute("data-del"));
      const all = state.monthData.logs.filter(l=>l.tab===tabName);
      const target = all[i];
      // remove by identity match
      const pos = state.monthData.logs.indexOf(target);
      if(pos>=0){
        state.monthData.logs.splice(pos,1);
        await saveMonth();
        renderAll();
      }
    };
  });
}

function renderOrdersOpenShipments(){
  const tbody=document.getElementById("openShipmentsBody");
  tbody.innerHTML="";

  // gather open sent from current month only (v65 baseline)
  const logs = state.monthData.logs.filter(l=>l.tab==="orders" && l.type==="sent");
  const open = logs.filter(l=>Number(l.remaining ?? l.qty) > 0);

  for(const l of open){
    const tr=document.createElement("tr");
    const remaining = Number(l.remaining ?? l.qty);
    tr.innerHTML = `
      <td>${state.currentMonth}</td>
      <td>${l.date||""}</td>
      <td>${l.product}</td>
      <td>${l.qty}</td>
      <td>${remaining}</td>
      <td>${l.note||""}</td>
      <td><input type="number" min="0" step="1" value="${remaining}" style="width:100px" data-rqty></td>
      <td><input type="date" value="${todayISO()}" style="width:160px" data-rdate></td>
      <td><button class="btn btn-success" data-recv>Receive</button></td>
    `;
    const btn = tr.querySelector("button[data-recv]");
    btn.onclick = async ()=>{
      const q = Number(tr.querySelector("input[data-rqty]").value || 0);
      const d = tr.querySelector("input[data-rdate]").value || todayISO();
      if(!Number.isFinite(q) || q<=0) return;
      if(q>remaining) { alert("Qty received cannot exceed remaining."); return; }

      // create received log in current month (adds stock)
      const actor=getActor();
      addLog({ tab:"orders", type:"received", date:d, product:l.product, qty:q, note:l.note||"", ...actor });

      // reduce remaining on sent
      const newRem = remaining - q;
      l.remaining = newRem;

      await saveMonth();
      renderAll();
    };
    tbody.appendChild(tr);
  }
}

function renderMovements(){
  // compile from current month logs only (simple)
  const tbody=document.getElementById("movementsTableBody");
  tbody.innerHTML="";
  const tabFilter=document.getElementById("movTab").value||"";
  const pSearch=(document.getElementById("movProductSearch").value||"").toLowerCase();
  const from=document.getElementById("movFrom").value||"";
  const to=document.getElementById("movTo").value||"";

  const logs = (state.monthData.logs||[]).map(l=>({month:state.currentMonth, ...l}));
  const filtered = logs.filter(l=>{
    if(tabFilter && l.tab!==tabFilter) return false;
    if(pSearch && !String(l.product||"").toLowerCase().includes(pSearch)) return false;
    if(from && (l.date||"")<from) return false;
    if(to && (l.date||"")>to) return false;
    return true;
  });

  for(const l of filtered){
    const tr=document.createElement("tr");
    tr.innerHTML=`<td>${l.month||""}</td><td>${l.date||""}</td><td>${l.tab||""}</td><td>${l.type||""}</td><td>${l.product||""}</td><td>${l.qty||""}</td><td>${l.note||""}</td><td>${l.by||""}</td>`;
    tbody.appendChild(tr);
  }
}

/* =========================
   Events / UI
========================= */
function showTab(tab){
  document.querySelectorAll(".tab-content").forEach(el=>el.classList.add("hidden"));
  document.getElementById(tab).classList.remove("hidden");
  document.querySelectorAll(".nav-item").forEach(n=>n.classList.toggle("active", n.dataset.tab===tab));
}

function applyRoleUI(){
  const navItems = document.querySelectorAll(".nav-item");
  if(state.role==="pl"){
    navItems.forEach(n=>{
      n.style.display = (n.dataset.tab==="general") ? "" : "none";
    });
    document.getElementById("plRealtimeInfo").style.display="";
  }else if(state.role==="pt"){
    navItems.forEach(n=>{ n.style.display=""; });
    document.getElementById("plRealtimeInfo").style.display="none";
  }else{
    navItems.forEach(n=>{ n.style.display="none"; });
    document.getElementById("plRealtimeInfo").style.display="none";
  }

  // backfill button only PT
  document.getElementById("btnBackfillGeneral").classList.toggle("hidden", state.role!=="pt");
}

function renderAll(){
  fillProductList();
  renderWarehouse();
  renderInit();
  renderGeneral();
  renderLogs("adjustTableBody","adjustments");
  renderLogs("returnsTableBody","returns");
  renderLogs("internalTableBody","internal");
  renderLogs("ordersTableBody","orders");
  renderLogs("amspedTableBody","amsped");
  renderLogs("b2bTableBody","b2b");
  renderOrdersOpenShipments();
  renderMovements();
}

function fillMovTabOptions(){
  const sel=document.getElementById("movTab");
  const tabs = ["adjustments","returns","internal","orders","amsped","b2b"];
  sel.innerHTML = `<option value="">All</option>` + tabs.map(t=>`<option value="${t}">${t}</option>`).join("");
}

async function init(){
  // month select
  const ms=document.getElementById("monthSelect");
  state.currentMonth = ensureMonthList(ms);

  // set defaults
  document.getElementById("internalDate").value=todayISO();
  document.getElementById("orderDate").value=todayISO();
  document.getElementById("shipDate").value=todayISO();
  document.getElementById("movFrom").value="";
  document.getElementById("movTo").value="";

  fillMovTabOptions();

  // nav clicks
  document.querySelectorAll(".nav-item").forEach(n=>{
    n.onclick=()=>showTab(n.dataset.tab);
  });

  // month change
  ms.onchange = async ()=>{
    state.currentMonth = ms.value;
    if(state.role==="pt"){
      await loadMonth(state.currentMonth);
      renderAll();
      // publish general snapshot
      await publishGeneralForMonth(state.currentMonth);
    }else if(state.role==="pl"){
      subscribePLGeneral(state.currentMonth);
    }
  };

  document.getElementById("newMonthBtn").onclick=()=>{
    // just ensures selector has current month, already populated; no-op
    alert("Select month from dropdown.");
  };

  // General
  document.getElementById("generalSearch").oninput=()=>renderGeneral();
  document.getElementById("refreshGeneralBtn").onclick=async ()=>{
    if(state.role==="pt"){
      await loadMonth(state.currentMonth);
      renderAll();
      await publishGeneralForMonth(state.currentMonth);
    }else if(state.role==="pl"){
      subscribePLGeneral(state.currentMonth);
    }
  };
  document.getElementById("btnBackfillGeneral").onclick=async ()=>{
    await backfillAllMonthsForPL();
    alert("Backfill done.");
  };

  // Warehouse upload/export
  document.getElementById("warehouseUploadBtn").onclick=()=>document.getElementById("warehouseFile").click();
  document.getElementById("warehouseFile").onchange=handleWarehouseFile;
  document.getElementById("warehouseExportBtn").onclick=exportWarehouseCsv;

  // Management
  document.getElementById("addInitBtn").onclick=async ()=>{
    const p=document.getElementById("initProduct").value.trim();
    const q=Number(document.getElementById("initQty").value||0);
    if(!p) return;
    ensureProductEntry(p).init = q;
    const actor=getActor();
    addLog({tab:"management", type:"init", date:todayISO(), product:p, qty:q, ...actor});
    await saveMonth();
    renderAll();
  };

  document.getElementById("btnImportInit").onclick=()=>document.getElementById("managementInitFile").click();
  document.getElementById("managementInitFile").onchange=handleInitFile;
  document.getElementById("btnExportInit").onclick=exportInitCsv;

  // Adjustments
  document.getElementById("addAdjustBtn").onclick=async ()=>{
    const type=document.getElementById("adjustmentType").value;
    const p=document.getElementById("adjustProduct").value.trim();
    const q=Number(document.getElementById("adjustQty").value||0);
    if(!p || !q) return;
    const actor=getActor();
    addLog({tab:"adjustments", type, date:todayISO(), product:p, qty:Math.abs(q), ...actor});
    await saveMonth();
    renderAll();
  };
  document.getElementById("addAdjustBulkBtn").onclick=async ()=>{
    const type=document.getElementById("adjustmentType").value;
    const items=parseBulkLines(document.getElementById("adjustBulk").value);
    const actor=getActor();
    for(const it of items){
      addLog({tab:"adjustments", type, date:todayISO(), product:it.product, qty:Math.abs(it.qty), ...actor});
    }
    document.getElementById("adjustBulk").value="";
    await saveMonth();
    renderAll();
  };

  // Returns
  document.getElementById("addReturnBtn").onclick=async ()=>{
    const type=document.getElementById("returnType").value;
    const p=document.getElementById("returnProduct").value.trim();
    const q=Number(document.getElementById("returnQty").value||0);
    if(!p || !q) return;
    const actor=getActor();
    addLog({tab:"returns", type, date:todayISO(), product:p, qty:Math.abs(q), ...actor});
    await saveMonth();
    renderAll();
  };
  document.getElementById("addReturnsBulkBtn").onclick=async ()=>{
    const type=document.getElementById("returnType").value;
    const items=parseBulkLines(document.getElementById("returnsBulk").value);
    const actor=getActor();
    for(const it of items){
      addLog({tab:"returns", type, date:todayISO(), product:it.product, qty:Math.abs(it.qty), ...actor});
    }
    document.getElementById("returnsBulk").value="";
    await saveMonth();
    renderAll();
  };

  // Internal
  document.getElementById("addInternalBtn").onclick=async ()=>{
    const type=document.getElementById("internalType").value;
    const date=document.getElementById("internalDate").value||todayISO();
    const p=document.getElementById("internalProduct").value.trim();
    const q=Number(document.getElementById("internalQty").value||0);
    if(!p || !q) return;
    const actor=getActor();
    addLog({tab:"internal", type, date, product:p, qty:Math.abs(q), ...actor});
    await saveMonth();
    renderAll();
  };
  document.getElementById("addInternalBulkBtn").onclick=async ()=>{
    const type=document.getElementById("internalType").value;
    const date=document.getElementById("internalDate").value||todayISO();
    const items=parseBulkLines(document.getElementById("internalBulk").value);
    const actor=getActor();
    for(const it of items){
      addLog({tab:"internal", type, date, product:it.product, qty:Math.abs(it.qty), ...actor});
    }
    document.getElementById("internalBulk").value="";
    await saveMonth();
    renderAll();
  };

  // Orders
  document.getElementById("addOrderBtn").onclick=async ()=>{
    const date=document.getElementById("orderDate").value||todayISO();
    const p=document.getElementById("orderProduct").value.trim();
    const q=Number(document.getElementById("orderQty").value||0);
    if(!p || !q) return;
    const actor=getActor();
    addLog({tab:"orders", type:"order", date, product:p, qty:Math.abs(q), ...actor});
    await saveMonth();
    renderAll();
  };
  document.getElementById("addOrderBulkBtn").onclick=async ()=>{
    const date=document.getElementById("orderDate").value||todayISO();
    const items=parseBulkLines(document.getElementById("orderBulk").value);
    const actor=getActor();
    for(const it of items){
      addLog({tab:"orders", type:"order", date, product:it.product, qty:Math.abs(it.qty), ...actor});
    }
    document.getElementById("orderBulk").value="";
    await saveMonth();
    renderAll();
  };
  document.getElementById("addShipBtn").onclick=async ()=>{
    const date=document.getElementById("shipDate").value||todayISO();
    const p=document.getElementById("shipProduct").value.trim();
    const q=Number(document.getElementById("shipQty").value||0);
    const note=(document.getElementById("shipNote").value||"").trim();
    if(!p || !q) return;
    const actor=getActor();
    addLog({tab:"orders", type:"sent", date, product:p, qty:Math.abs(q), remaining:Math.abs(q), note, ...actor});
    document.getElementById("shipNote").value="";
    await saveMonth();
    renderAll();
  };
  document.getElementById("addShipBulkBtn").onclick=async ()=>{
    const date=document.getElementById("shipDate").value||todayISO();
    const note=(document.getElementById("shipBulkNote").value||"").trim();
    const items=parseBulkLines(document.getElementById("shipBulk").value);
    const actor=getActor();
    for(const it of items){
      addLog({tab:"orders", type:"sent", date, product:it.product, qty:Math.abs(it.qty), remaining:Math.abs(it.qty), note, ...actor});
    }
    document.getElementById("shipBulk").value="";
    await saveMonth();
    renderAll();
  };

  // Amsped
  document.getElementById("addAmspedBtn").onclick=async ()=>{
    const p=document.getElementById("amspedProduct").value.trim();
    const q=Number(document.getElementById("amspedQty").value||0);
    if(!p || !q) return;
    const actor=getActor();
    addLog({tab:"amsped", type:"amsped", date:todayISO(), product:p, qty:Math.abs(q), ...actor});
    await saveMonth();
    renderAll();
  };
  document.getElementById("addAmspedBulkBtn").onclick=async ()=>{
    const items=parseBulkLines(document.getElementById("amspedBulk").value);
    const actor=getActor();
    for(const it of items){
      addLog({tab:"amsped", type:"amsped", date:todayISO(), product:it.product, qty:Math.abs(it.qty), ...actor});
    }
    document.getElementById("amspedBulk").value="";
    await saveMonth();
    renderAll();
  };

  // B2B
  document.getElementById("addB2bBtn").onclick=async ()=>{
    const p=document.getElementById("b2bProduct").value.trim();
    const q=Number(document.getElementById("b2bQty").value||0);
    if(!p || !q) return;
    const actor=getActor();
    addLog({tab:"b2b", type:"b2b", date:todayISO(), product:p, qty:Math.abs(q), ...actor});
    await saveMonth();
    renderAll();
  };
  document.getElementById("addB2bBulkBtn").onclick=async ()=>{
    const items=parseBulkLines(document.getElementById("b2bBulk").value);
    const actor=getActor();
    for(const it of items){
      addLog({tab:"b2b", type:"b2b", date:todayISO(), product:it.product, qty:Math.abs(it.qty), ...actor});
    }
    document.getElementById("b2bBulk").value="";
    await saveMonth();
    renderAll();
  };

  // Movements
  document.getElementById("movApplyBtn").onclick=()=>renderMovements();
  document.getElementById("exportMovementsCsvBtn").onclick=exportMovementsCsv;
  document.getElementById("exportMovementsXlsxBtn").onclick=exportMovementsXlsx;

  // Auth buttons
  document.getElementById("btnLogin").onclick=doLogin;
  document.getElementById("btnLogout").onclick=doLogout;

  // Initial hide tabs until auth
  applyRoleUI();

  // load base data if already signed in
  wireAuth();

  // initial UI
  showTab("general");
}

let plUnsub=null;
function subscribePLGeneral(monthId){
  if(plUnsub){ plUnsub(); plUnsub=null; }
  const { db, doc, onSnapshot } = window.__fb;
  const ref = doc(db, "general", monthId);
  plUnsub = onSnapshot(ref, { includeMetadataChanges:true }, (snap)=>{
    if(!snap.exists()){
      state.plGeneralItems=[];
      document.getElementById("generalLastUpdate").textContent = "Last update: (no snapshot yet ‚Äî PT must publish)";
      renderGeneral();
      return;
    }
    const data=snap.data();
    state.plGeneralItems = Array.isArray(data.items) ? data.items : [];
    document.getElementById("generalLastUpdate").textContent = "Last update: " + (data.updatedBy ? `by ${data.updatedBy}` : "ok");
    renderGeneral();
  }, (err)=>{
    console.error(err);
    document.getElementById("generalLastUpdate").textContent = "Last update: ERROR ("+err.message+")";
    state.plGeneralItems=[];
    renderGeneral();
  });
}

async function doLogin(){
  const email=document.getElementById("loginEmail").value.trim();
  const pass=document.getElementById("loginPass").value;
  if(!email || !pass) return;
  try{
    await window.__fb.signInWithEmailAndPassword(window.__fb.auth, email, pass);
  }catch(e){
    alert("Login failed: " + e.message);
  }
}
async function doLogout(){
  try{
    await window.__fb.signOut(window.__fb.auth);
  }catch(e){
    alert("Logout failed: " + e.message);
  }
}

function wireAuth(){
  window.__fb.onAuthStateChanged(window.__fb.auth, async (user)=>{
    if(!user){
      state.role="none";
      state.userEmail="";
      document.getElementById("authStatus").textContent="Not signed in";
      document.getElementById("btnLogin").classList.remove("hidden");
      document.getElementById("btnLogout").classList.add("hidden");
      applyRoleUI();
      return;
    }
    state.userEmail = user.email || "";
    if(isPTEmail(state.userEmail)) state.role="pt";
    else if(isPLEmail(state.userEmail)) state.role="pl";
    else state.role="none";

    document.getElementById("authStatus").textContent = `Signed in: ${state.userEmail} (${state.role.toUpperCase()})`;
    document.getElementById("btnLogin").classList.add("hidden");
    document.getElementById("btnLogout").classList.remove("hidden");

    applyRoleUI();

    await loadWarehouse();
    fillProductList();

    if(state.role==="pt"){
      await loadMonth(state.currentMonth);
      renderAll();
      await publishGeneralForMonth(state.currentMonth);
    }else if(state.role==="pl"){
      subscribePLGeneral(state.currentMonth);
      showTab("general");
    }else{
      alert("Email not allowed.");
    }
  });
}

/* =========================
   File imports/exports
========================= */
async function handleWarehouseFile(evt){
  const file=evt.target.files?.[0];
  if(!file) return;
  const ext=(file.name.split('.').pop()||"").toLowerCase();

  let rows=[];
  if(ext==="csv"){
    const text=await file.text();
    const lines=text.split(/\r?\n/).filter(l=>l.trim().length);
    for(const line of lines){
      // CSV can be ; or ,
      const parts=line.includes(";") ? line.split(";") : line.split(",");
      rows.push(parts.map(p=>p.trim()));
    }
  }else{
    const data=await file.arrayBuffer();
    const wb=XLSX.read(data,{type:"array"});
    const ws=wb.Sheets[wb.SheetNames[0]];
    rows=XLSX.utils.sheet_to_json(ws,{header:1});
  }

  // Skip header if contains "produto"
  if(rows.length && String(rows[0][0]||"").toLowerCase().includes("prod")){
    rows=rows.slice(1);
  }

  const items=[];
  for(const r of rows){
    const product=String(r[0]||"").trim();
    if(!product) continue;
    const position=String(r[1]||"").trim();
    const dimensions=String(r[2]||"").trim();
    const weight=String(r[3]||"").trim();
    const volume=dimToVolume(dimensions); // ignore column E
    items.push({product, position, dimensions, weight, volume});
  }

  state.warehouse=items;
  await saveWarehouse();
  fillProductList();
  renderWarehouse();
  renderGeneral();
}

function downloadText(filename, text){
  const blob=new Blob([text],{type:"text/plain;charset=utf-8"});
  const url=URL.createObjectURL(blob);
  const a=document.createElement("a");
  a.href=url;
  a.download=filename;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
}

function exportWarehouseCsv(){
  const sep=";";
  const lines=["sep=;","Product;Position;Dimensions;Weight;Volume"];
  for(const w of state.warehouse){
    lines.push([w.product,w.position,w.dimensions,w.weight,(w.volume ?? dimToVolume(w.dimensions))].map(v=>String(v??"").replaceAll(";"," ")).join(sep));
  }
  downloadText(`warehouse_${state.currentMonth}.csv`, lines.join("\n"));
}

async function handleInitFile(evt){
  const file=evt.target.files?.[0];
  if(!file) return;
  const ext=(file.name.split('.').pop()||"").toLowerCase();

  let rows=[];
  if(ext==="csv"){
    const text=await file.text();
    const lines=text.split(/\r?\n/).filter(l=>l.trim().length);
    for(const line of lines){
      const parts=line.includes(";") ? line.split(";") : line.split(",");
      rows.push(parts.map(p=>p.trim()));
    }
  }else{
    const data=await file.arrayBuffer();
    const wb=XLSX.read(data,{type:"array"});
    const ws=wb.Sheets[wb.SheetNames[0]];
    rows=XLSX.utils.sheet_to_json(ws,{header:1});
  }

  if(rows.length && String(rows[0][0]||"").toLowerCase().includes("prod")){
    rows=rows.slice(1);
  }

  // reset init to 0 for all products
  for(const p of getAllProducts()){
    ensureProductEntry(p).init = 0;
  }

  for(const r of rows){
    const product=String(r[0]||"").trim();
    if(!product) continue;
    const qty=Number(r[1]||0);
    ensureProductEntry(product).init = Number.isFinite(qty) ? qty : 0;
  }

  await saveMonth();
  renderAll();
}

function exportInitCsv(){
  const sep=";";
  const lines=["sep=;","Product;InitQty"];
  const items = getAllProducts().map(p=>({p, q:Number(state.monthData.products[p]?.init||0)}));
  for(const it of items){
    lines.push(`${it.p.replaceAll(";"," ")};${it.q}`);
  }
  downloadText(`init_${state.currentMonth}.csv`, lines.join("\n"));
}

function exportMovementsCsv(){
  const sep=";";
  const lines=["sep=;","Month;Date;Tab;Type;Product;Qty;Obs;By"];
  const logs = (state.monthData.logs||[]).map(l=>({month:state.currentMonth, ...l}));
  for(const l of logs){
    lines.push([l.month,l.date,l.tab,l.type,l.product,l.qty,(l.note||""),(l.by||"")].map(v=>String(v??"").replaceAll(";"," ")).join(sep));
  }
  downloadText(`movements_${state.currentMonth}.csv`, lines.join("\n"));
}
function exportMovementsXlsx(){
  const logs = (state.monthData.logs||[]).map(l=>({
    month: state.currentMonth,
    date: l.date||"",
    tab: l.tab||"",
    type: l.type||"",
    product: l.product||"",
    qty: l.qty||"",
    obs: l.note||"",
    by: l.by||""
  }));
  const ws=XLSX.utils.json_to_sheet(logs);
  const wb=XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "Movements");
  XLSX.writeFile(wb, `movements_${state.currentMonth}.xlsx`);
}

/* =========================
   Boot
========================= */
document.addEventListener("DOMContentLoaded", init);
</script>
</body>
</html>
